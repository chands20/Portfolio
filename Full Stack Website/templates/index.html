{% extends "base.html" %}

{% block content %}
    <h1>Hello, {{ current_user.username }}!</h1>

    <p><a href="{{ url_for('submit_joke') }}">Submit a New Joke</a></p>
    <hr>

    <h2>Joke Feed:</h2>
    {% for joke in jokes %}
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <p>
                <strong>
                    <a href="{{ url_for('profile', username=joke.author.username) }}">
                        {{ joke.author.username }}
                    </a>
                </strong>
                <span style="color: #888;">(on {{ joke.timestamp.strftime('%Y-%m-%d') }})</span>
                {% if joke.author == current_user %}
                    <a href="{{ url_for('edit_joke', joke_id=joke.id) }}">ğŸ“</a>
                {% elif current_user.role == 'admin' %}
                    <a href="{{ url_for('admin_edit_joke', joke_id=joke.id) }}">ğŸ“</a>
                {% endif %}
            </p>
            <p>{{ joke.body }}</p>

            {% if joke.author == current_user %}
                <p><a href="{{ url_for('edit_joke', joke_id=joke.id) }}">Edit Joke</a></p>
            {% endif %}
            <p>{{ joke.body }} (by {{ joke.author.username }})</p>

            <p><b>Rating: {{ joke.average_rating() }} / 5.0</b></p>

            {% if joke.author != current_user %}
                {% set existing_rating = joke.ratings.filter_by(user_id=current_user.id).first() %}
                {% if not existing_rating %}
                    <p><a href="{{ url_for('rate_joke', joke_id=joke.id) }}">Rate this Joke</a></p>
                {% else %}
                    <p><i>(You rated this joke {{ existing_rating.score }} stars)</i></p>
                {% endif %}
            {% endif %}
            <hr>
        </div>
    {% else %}
        <p>No jokes yet! Be the first to submit one.</p>
    {% endfor %}
{% endblock %}
