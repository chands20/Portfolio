{% extends "base.html" %}

{% block content %}
    <h1>User Profile: {{ user.username }}</h1>
    <p>Email: {{ user.email }}</p>
    <p>Role: {{ user.role }}</p>

    {% if current_user.role == 'admin' %}
        <p>
            <a href="{{ url_for('admin_edit_user', user_id=user.id) }}">
                Admin: Edit This User
            </a>
        </p>
    {% endif %}

    <hr>

    <h2>Jokes by {{ user.username }}:</h2>

    {% for joke in jokes %}
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <p>
                <strong>{{ joke.author.username }}</strong>
                <span style="color: #888;">(on {{ joke.timestamp.strftime('%Y-%m-%d') }})</span>
            </p>
            <p>{{ joke.body }}</p>

            {% if joke.author == current_user %}
                <p><a href="{{ url_for('edit_joke', joke_id=joke.id) }}">Edit Joke</a></p>
            {% elif current_user.role == 'admin' %}
                <p><a href="{{ url_for('admin_edit_joke', joke_id=joke.id) }}">Edit Joke</a></p>
            {% endif %}

            <p><b>Rating: {{ joke.average_rating() }} / 5.0</b></p>

            {% if joke.author != current_user %}
                {% set existing_rating = joke.ratings.filter_by(user_id=current_user.id).first() %}
                {% if not existing_rating %}
                    <p><a href="{{ url_for('rate_joke', joke_id=joke.id) }}">Rate this Joke</a></p>
                {% else %}
                    <p><i>(You rated this joke {{ existing_rating.score }} stars)</i></p>
                {% endif %}
            {% endif %}
            <hr>
        </div>
    {% else %}
        <p>{{ user.username }} has not submitted any jokes yet.</p>
    {% endfor %}
{% endblock %}
